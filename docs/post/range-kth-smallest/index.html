<!DOCTYPE html>
<html lang="ja">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>



<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Range Kth Smallestに対する4つの解法と2つの実装例 - InTheDayDream</title>
<meta name="description" content="">

<meta name="author" content="">

<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?c=ecbb6b0d25d205e98237def9b80701f9d7bec2a3">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?c=ecbb6b0d25d205e98237def9b80701f9d7bec2a3">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?c=ecbb6b0d25d205e98237def9b80701f9d7bec2a3">
<link rel="alternate" href="/index.xml?c=ecbb6b0d25d205e98237def9b80701f9d7bec2a3" type="application/rss+xml" title="RSS" />
<meta property="og:title" content="Range Kth Smallestに対する4つの解法と2つの実装例 - InTheDayDream">
<meta property="og:url" content="http://localhost:1313/post/range-kth-smallest/">
<meta property="og:type" content="article">
<meta property="og:site_name" content="InTheDayDream">
<meta property="og:description" content="">

<meta property="og:image" content="http://localhost:1313//images/featured_image.jpg">

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@UU9782wsEdANDhp">
<meta name="twitter:creator" content="@UU9782wsEdANDhp">
<meta name="twitter:title" content="Range Kth Smallestに対する4つの解法と2つの実装例 - InTheDayDream">
<meta name="twitter:url" content="http://localhost:1313/post/range-kth-smallest/">
<meta name="twitter:description" content="">

<meta property="og:image" content="http://localhost:1313//images/featured_image.jpg">


<link rel="stylesheet" href="/css/main.css?c=ecbb6b0d25d205e98237def9b80701f9d7bec2a3">
<link rel="stylesheet" href="/css/color.css?c=ecbb6b0d25d205e98237def9b80701f9d7bec2a3">


<link rel="stylesheet" href="/css/custom.css?c=ecbb6b0d25d205e98237def9b80701f9d7bec2a3">



</head>

<body class="theme-default">





<link rel="stylesheet" href="/katex/katex.min.css">
<script defer src="/katex/katex.min.js"></script>
<script defer src="/katex/contrib/auto-render.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              
              
          ],
          
          throwOnError : false
        });
    });
</script>



<div id="content-header" class="title">
  
  <a class="site-title" href="/">InTheDayDream</a>
  
  <span class="site-sub-title"></span>

  

  <div id="main-menu-nav">
    <div id="main-menu-nav-items">
      
        <div class="nav-item"><a href="/">Home</a></div>
      
        <div class="nav-item"><a href="/tags/">Tags</a></div>
      
        <div class="nav-item"><a href="/archives/">Archives</a></div>
      
        <div class="nav-item"><a href="/about/">About</a></div>
      
        <div class="nav-item"><a href="/search/">Search</a></div>
      
    </div>
  </div>
</div>
<div id="content" class="main">




<h1>Range Kth Smallestに対する4つの解法と2つの実装例</h1>

<span class="sub">Published on 2024-09-07</span><br>
<span class="sub">Last Modified 2024-09-07</span>






<div style="padding: 0em 1em; margin-bottom: 5em; margin-top: 0.7em;">
    <p style="font-size: 1.3em;">Table Of Contents</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#問題">問題</a></li>
    <li><a href="#解法1">解法1</a></li>
    <li><a href="#解法2">解法2</a></li>
    <li><a href="#解法3">解法3</a></li>
    <li><a href="#解法4">解法4</a></li>
    <li><a href="#おわりに">おわりに</a></li>
  </ul>
</nav>
</div>



<h2 id="問題">問題</h2>
<p>$N$要素の数列$A$が与えられる。$Q$個のクエリに解答せよ。</p>
<ul>
<li>$A$の$[l _ i, r _ i)$内にある要素の中で$k _ i + 1$番目に小さい値を答える。</li>
</ul>
<p>$1 \leq N \leq 2 \times 10 ^ 5, \quad 1 \leq Q \leq 2 \times 10 ^ 5, \quad 1 \leq A _ i \leq 10 ^ 9$</p>
<p>
<a
  
    href="https://judge.yosupo.jp/problem/range_kth_smallest"
  
   target="_blank" rel="noopener">
    ジャッジ(library checker)
</a>
</p>
<h2 id="解法1">解法1</h2>
<p>rectangle sumに帰着させる。
横軸に数列のインデックス、縦軸に値の大きさをとる二次元平面を考え、各$A _ i$に対応する場所に+1を積んでおく。</p>
<p>各クエリでは、x座標$[l _ i, r _ i)$に対してy軸方向$[-\infty, v]$の総和をとる。この値は$v$に対して広義単調増加であるから、ちょうど$k _ i + 1$以上になる最小の$v$は二分探索で求まる。</p>
<p>クエリ$O(\log N \log N \log (\max A _ i))$程度(使うデータ構造によって多少揺れると思われる。なんかいい感じにやるとlog一つくらい落ちるかも)</p>
<p>やりようによってはonlineクエリかつ列の変更クエリありでも動く。
rectangle sumの良い感じのやつをまだ持っていないので実装例なし。</p>
<h2 id="解法2">解法2</h2>
<p>wavelet matrixを用いる。wavelet matrixはこのクエリをサポートしているので、やるだけになる。
クエリ$O(\log (\max A _ i))$</p>
<p>onlineクエリでできるが、列の変更クエリなしのみ対応。dynamic wavelet matrixを用いればlogが付く代わりに変更クエリをさばける。(多分)
当然持っていないので実装例なし。</p>
<p>
<a
  
    href="https://miti-7.hatenablog.com/entry/2019/02/01/143655"
  
   target="_blank" rel="noopener">
    dynamic wavelet matrixってこんなやつ
</a>
</p>
<p>ちなみに現在のlibrary checker最速実行時間はこの方針に改造を加えたものだと思われる。</p>
<h2 id="解法3">解法3</h2>
<p>並列二分探索を用いる。</p>
<p>並列二分探索のことはいったん忘れて、クエリ$[l _ i, r _ i)$を考えることにする。</p>
<p>配列$B = (0, 0, \dots, 0)$を用意して、$A _ i$が小さい$i$から順番に$B _ i = 1$としていくことにする。</p>
<p>上記操作を進めていく中で、配列$B$の$[l _ i, r _ i)$におけるRange Sum Queryの値がはじめて$k _ i + 1$以上になったときの$A _ i$がRange Kth Smallestの解である。
そして、クエリ結果が$k _ i + 1$以上になるかどうかは操作の進度に対して単調であるから、二分探索ができる。</p>
<p>各クエリの二分探索は並列化することで計算量を均す。
具体的には、$B _ i = 1$にしていく$N$回の操作1セットを行う途中に、すべてのクエリの二分探索を一段階進めることにする。</p>
<p>セグメント木を用いると、Range Sum Queryの更新1セット分が$O(N \log N)$で、二分探索更新1セット分が$O(Q \log N)$になる。
$O(\log N)$セット行えばすべての二分探索が終わるので、全体$O((N + Q) \log ^ 2 N)$</p>
<p>offlineかつ変更クエリなしのみ対応。</p>
<p>
<a
  
    href="https://judge.yosupo.jp/submission/233545"
  
   target="_blank" rel="noopener">
    AC(879ms)
</a>
</p>
<p>
<a
  
    href="https://jupiro.hatenablog.com/entry/2022/02/20/110013"
  
   target="_blank" rel="noopener">
    参考元
</a>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-d" data-lang="d"><span style="display:flex;"><span><span style="color:#75715e">/// Range Kth Smallest (offlineかつstatic)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// 並列二分探索による解法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// aの昇順に配列を構築していくと考える。aをどこまで使えば区間[li, ri]にki以上の要素が入るかを考えると、これは単調である。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// よって、どこまで使うかを二分探索で求めることが出来る。その境界にある要素がまさにRange Kth Smallestの解である。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> std<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span> <span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> N<span style="color:#f92672">,</span> Q<span style="color:#f92672">;</span> readln<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>N<span style="color:#f92672">,</span> Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> a <span style="color:#f92672">=</span> readln<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">.</span><span style="color:#a6e22e">to</span><span style="color:#f92672">!(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">[]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> l <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> r <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> k <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">;</span> <span style="color:#ae81ff">0.</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Q</span><span style="color:#f92672">)</span> readln<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>l<span style="color:#f92672">[</span>i<span style="color:#f92672">],</span> r<span style="color:#f92672">[</span>i<span style="color:#f92672">],</span> k<span style="color:#f92672">[</span>i<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> rsq <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SegmentTree<span style="color:#f92672">!(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> a<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> b<span style="color:#f92672">)</span> <span style="color:#f92672">=&gt;</span> a <span style="color:#f92672">+</span> b<span style="color:#f92672">,</span> <span style="color:#f92672">()</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)(</span>N<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> ok <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> ng <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> mid <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ok<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> N <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    ng<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> value_ord <span style="color:#f92672">=</span> iota<span style="color:#f92672">(</span>N<span style="color:#f92672">).</span><span style="color:#a6e22e">array</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">!((</span>i<span style="color:#f92672">,</span> j<span style="color:#f92672">)</span> <span style="color:#f92672">=&gt;</span> a<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;</span> a<span style="color:#f92672">[</span>j<span style="color:#f92672">]).</span><span style="color:#a6e22e">array</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> query_ord <span style="color:#f92672">=</span> iota<span style="color:#f92672">(</span>Q<span style="color:#f92672">).</span><span style="color:#a6e22e">array</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bool</span> end <span style="color:#f92672">=</span> <span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">;</span> <span style="color:#ae81ff">0.</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Q</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;</span> abs<span style="color:#f92672">(</span>ok<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">-</span> ng<span style="color:#f92672">[</span>i<span style="color:#f92672">]))</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>end<span style="color:#f92672">)</span> <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// セグメント木のリセット
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">;</span> <span style="color:#ae81ff">0.</span><span style="color:#f92672">.</span><span style="color:#a6e22e">N</span><span style="color:#f92672">)</span> rsq<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>i<span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// midの計算 + midの昇順にソート
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">;</span> <span style="color:#ae81ff">0.</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Q</span><span style="color:#f92672">)</span> mid<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ok<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> ng<span style="color:#f92672">[</span>i<span style="color:#f92672">])</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        query_ord<span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">!((</span>i<span style="color:#f92672">,</span> j<span style="color:#f92672">)</span> <span style="color:#f92672">=&gt;</span> mid<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;</span> mid<span style="color:#f92672">[</span>j<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> L <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> R <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>count<span style="color:#f92672">,</span> i<span style="color:#f92672">;</span> value_ord<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 点追加
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            rsq<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>i<span style="color:#f92672">,</span> rsq<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>L <span style="color:#f92672">&lt;</span> Q <span style="color:#f92672">&amp;&amp;</span> count <span style="color:#f92672">==</span> mid<span style="color:#f92672">[</span>query_ord<span style="color:#f92672">[</span>L<span style="color:#f92672">]])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>R <span style="color:#f92672">&lt;</span> Q<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mid<span style="color:#f92672">[</span>query_ord<span style="color:#f92672">[</span>R<span style="color:#f92672">]]</span> <span style="color:#f92672">!=</span> count<span style="color:#f92672">)</span> <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    R<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 二分探索を一段階進める
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">;</span> L<span style="color:#f92672">..</span><span style="color:#a6e22e">R</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">int</span> qidx <span style="color:#f92672">=</span> query_ord<span style="color:#f92672">[</span>U<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> k<span style="color:#f92672">[</span>qidx<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;=</span> rsq<span style="color:#f92672">.</span><span style="color:#a6e22e">prod</span><span style="color:#f92672">(</span>l<span style="color:#f92672">[</span>qidx<span style="color:#f92672">],</span> r<span style="color:#f92672">[</span>qidx<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>f<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        ok<span style="color:#f92672">[</span>qidx<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> mid<span style="color:#f92672">[</span>qidx<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        ng<span style="color:#f92672">[</span>qidx<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> mid<span style="color:#f92672">[</span>qidx<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                L <span style="color:#f92672">=</span> R<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">;</span> <span style="color:#ae81ff">0.</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Q</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        writeln<span style="color:#f92672">(</span>a<span style="color:#f92672">[</span>value_ord<span style="color:#f92672">[</span>ok<span style="color:#f92672">[</span>i<span style="color:#f92672">]]]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">read</span> <span style="color:#f92672">(</span>T<span style="color:#f92672">...)</span> <span style="color:#f92672">(</span>string S<span style="color:#f92672">,</span> <span style="color:#66d9ef">ref</span> T args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> std.conv <span style="color:#f92672">:</span> to<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> std.array <span style="color:#f92672">:</span> split<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> buf <span style="color:#f92672">=</span> S<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">,</span> <span style="color:#66d9ef">ref</span> arg<span style="color:#f92672">;</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        arg <span style="color:#f92672">=</span> buf<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">to</span><span style="color:#f92672">!(</span><span style="color:#66d9ef">typeof</span><span style="color:#f92672">(</span>arg<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// セグメント木は省略
</span></span></span></code></pre></div><h2 id="解法4">解法4</h2>
<p>Mo&rsquo;s algorithmと平方分割によるRange Sum Queryを用いる。</p>
<p>$A$を座標圧縮した後の値を横軸に、その値の出現回数を縦軸にとるRange Sum Queryを考える。
ある区間$[l _ i, r _ i)$のなかにある$A$の要素だけで上記Range Sum Queryを構築することにすると、$[0, x]$のRange Sum Queryがはじめて$k _ i + 1$以上になる$x$がRange Kth Smallestの解になる。</p>
<p>クエリ区間の巡回はMo&rsquo;s algorithmにより$O(N \sqrt{Q})$でできる。Range Sum Queryに平方分割を採用すると、Moの更新が$O(1)$、解の取得が$O(\sqrt{N})$で出来る。(実はRange Sum Queryにセグメント木を用いるより高速になる。)</p>
<p>全体$O(Q \sqrt{N} + N \sqrt{Q})$</p>
<p>offlineかつ変更クエリなしのみ対応。</p>
<p>
<a
  
    href="https://judge.yosupo.jp/submission/233551"
  
   target="_blank" rel="noopener">
    AC(372ms)
</a>
</p>
<p>参考</p>
<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">1点更新range sumを平方分割でやると、更新がO(1)でクエリがO(√N)になって、Moと相性が良くなるの、おもしろ〜〜〜</p>&mdash; けむにく＠競プロ (@kemuniku) <a href="https://twitter.com/kemuniku/status/1787782215193231849?ref_src=twsrc%5Etfw">May 7, 2024</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-d" data-lang="d"><span style="display:flex;"><span><span style="color:#75715e">/// Range Kth Smallest (offlineかつstatic)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// Mo&#39;s algorithm + 平方分割rsqによる解法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// aに含まれる要素で座標圧縮をし、横軸が座標圧縮後のindexとなるrsqを考える。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// Moによって区間を巡回し、区間内の要素で上のrsqに積んでいくことにすると、[0, x)がはじめてkiを超える場所がRange Kth Smallestの解になる。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// ここで、rsqに平方分割を採用すると、更新O(1)、ki以上の場所の取得がO(√N)であるから、全体O(Q√N + N√Q)で解ける。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// 補足1: ki以上の場所がO(√N)になるからくり
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// 先頭から足していくことにして、足して初めてki以上になるブロックを見つける。ここまでO(√N)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// ブロック内で厳密にkiになる場所を探す。ここでO(√N)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// 合計O(√N)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// 補足2: 座圧後のrsqで平方分割を使っているのは、セグメント木を用いるより全体の計算量が良くなるから。Mo&#39;s algorithmでは移動が支配的なので、取得を多少遅くしたとしても更新を早くする方が有利になる。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> std<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span> <span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> N<span style="color:#f92672">,</span> Q<span style="color:#f92672">;</span> readln<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>N<span style="color:#f92672">,</span> Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> a <span style="color:#f92672">=</span> readln<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">.</span><span style="color:#a6e22e">to</span><span style="color:#f92672">!(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">[]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> l <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> r <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> k <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> ans <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">;</span> <span style="color:#ae81ff">0.</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Q</span><span style="color:#f92672">)</span> readln<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>l<span style="color:#f92672">[</span>i<span style="color:#f92672">],</span> r<span style="color:#f92672">[</span>i<span style="color:#f92672">],</span> k<span style="color:#f92672">[</span>i<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// mo&#39;s algorithmの準備
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> mo_width <span style="color:#f92672">=</span> max<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> sqrt<span style="color:#f92672">(</span>Q<span style="color:#f92672">.</span><span style="color:#a6e22e">to</span><span style="color:#f92672">!</span><span style="color:#66d9ef">double</span><span style="color:#f92672">).</span><span style="color:#a6e22e">to</span><span style="color:#f92672">!</span><span style="color:#66d9ef">int</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> priority <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>Q<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">;</span> <span style="color:#ae81ff">0.</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Q</span><span style="color:#f92672">)</span> priority<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> l<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">/</span> mo_width<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">less</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> j<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>priority<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> priority<span style="color:#f92672">[</span>j<span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>priority<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">return</span> r<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;</span> r<span style="color:#f92672">[</span>j<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> r<span style="color:#f92672">[</span>j<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;</span> r<span style="color:#f92672">[</span>i<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> priority<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;</span> priority<span style="color:#f92672">[</span>j<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> query_ord <span style="color:#f92672">=</span> iota<span style="color:#f92672">(</span>Q<span style="color:#f92672">).</span><span style="color:#a6e22e">array</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">!(</span>less<span style="color:#f92672">).</span><span style="color:#a6e22e">array</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 平方分割の準備
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">auto</span> f <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>N<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> max_f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> index <span style="color:#f92672">=</span> iota<span style="color:#f92672">(</span>N<span style="color:#f92672">).</span><span style="color:#a6e22e">array</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">!((</span>i<span style="color:#f92672">,</span> j<span style="color:#f92672">)</span> <span style="color:#f92672">=&gt;</span> a<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;</span> a<span style="color:#f92672">[</span>j<span style="color:#f92672">]).</span><span style="color:#a6e22e">array</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> b <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span><span style="color:#a6e22e">dup</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uniq</span><span style="color:#f92672">.</span><span style="color:#a6e22e">array</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> L <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> R <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>L <span style="color:#f92672">&lt;</span> N<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>R <span style="color:#f92672">&lt;</span> N<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>a<span style="color:#f92672">[</span>index<span style="color:#f92672">[</span>L<span style="color:#f92672">]]</span> <span style="color:#f92672">!=</span> a<span style="color:#f92672">[</span>index<span style="color:#f92672">[</span>R<span style="color:#f92672">]])</span> <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                R<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>U<span style="color:#f92672">;</span> L<span style="color:#f92672">..</span><span style="color:#a6e22e">R</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                f<span style="color:#f92672">[</span>index<span style="color:#f92672">[</span>U<span style="color:#f92672">]]</span> <span style="color:#f92672">=</span> max_f<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            max_f<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            L <span style="color:#f92672">=</span> R<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> width <span style="color:#f92672">=</span> max<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> sqrt<span style="color:#f92672">(</span>max_f<span style="color:#f92672">.</span><span style="color:#a6e22e">to</span><span style="color:#f92672">!</span><span style="color:#66d9ef">double</span><span style="color:#f92672">).</span><span style="color:#a6e22e">to</span><span style="color:#f92672">!</span><span style="color:#66d9ef">int</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> block_count <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>max_f <span style="color:#f92672">/</span> width <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> count <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[](</span>max_f <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> L <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> R <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">;</span> query_ord<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 区間合わせ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>L <span style="color:#f92672">&lt;</span> l<span style="color:#f92672">[</span>i<span style="color:#f92672">])</span> <span style="color:#f92672">{</span> block_count<span style="color:#f92672">[</span>f<span style="color:#f92672">[</span>L<span style="color:#f92672">]</span> <span style="color:#f92672">/</span> width<span style="color:#f92672">]--;</span> count<span style="color:#f92672">[</span>f<span style="color:#f92672">[</span>L<span style="color:#f92672">]]--;</span> L<span style="color:#f92672">++;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>l<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;</span> L<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> L<span style="color:#f92672">--;</span> block_count<span style="color:#f92672">[</span>f<span style="color:#f92672">[</span>L<span style="color:#f92672">]</span> <span style="color:#f92672">/</span> width<span style="color:#f92672">]++;</span> count<span style="color:#f92672">[</span>f<span style="color:#f92672">[</span>L<span style="color:#f92672">]]++;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>R <span style="color:#f92672">&lt;</span> r<span style="color:#f92672">[</span>i<span style="color:#f92672">])</span> <span style="color:#f92672">{</span> block_count<span style="color:#f92672">[</span>f<span style="color:#f92672">[</span>R<span style="color:#f92672">]</span> <span style="color:#f92672">/</span> width<span style="color:#f92672">]++;</span> count<span style="color:#f92672">[</span>f<span style="color:#f92672">[</span>R<span style="color:#f92672">]]++;</span> R<span style="color:#f92672">++;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;</span> R<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> R<span style="color:#f92672">--;</span> block_count<span style="color:#f92672">[</span>f<span style="color:#f92672">[</span>R<span style="color:#f92672">]</span> <span style="color:#f92672">/</span> width<span style="color:#f92672">]--;</span> count<span style="color:#f92672">[</span>f<span style="color:#f92672">[</span>R<span style="color:#f92672">]]--;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 取得
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> acc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> cur_block <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>acc <span style="color:#f92672">+</span> block_count<span style="color:#f92672">[</span>cur_block<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;</span> k<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            acc <span style="color:#f92672">+=</span> block_count<span style="color:#f92672">[</span>cur_block<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>            cur_block<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ブロック内走査
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> cur <span style="color:#f92672">=</span> cur_block <span style="color:#f92672">*</span> width<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>acc <span style="color:#f92672">+</span> count<span style="color:#f92672">[</span>cur<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;</span> k<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            acc <span style="color:#f92672">+=</span> count<span style="color:#f92672">[</span>cur<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>            cur<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ans<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> b<span style="color:#f92672">[</span>cur<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">;</span> <span style="color:#ae81ff">0.</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Q</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        writeln<span style="color:#f92672">(</span>ans<span style="color:#f92672">[</span>i<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">read</span> <span style="color:#f92672">(</span>T<span style="color:#f92672">...)</span> <span style="color:#f92672">(</span>string S<span style="color:#f92672">,</span> <span style="color:#66d9ef">ref</span> T args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> std.conv <span style="color:#f92672">:</span> to<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> std.array <span style="color:#f92672">:</span> split<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> buf <span style="color:#f92672">=</span> S<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> <span style="color:#f92672">(</span>i<span style="color:#f92672">,</span> <span style="color:#66d9ef">ref</span> arg<span style="color:#f92672">;</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        arg <span style="color:#f92672">=</span> buf<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">to</span><span style="color:#f92672">!(</span><span style="color:#66d9ef">typeof</span><span style="color:#f92672">(</span>arg<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="おわりに">おわりに</h2>
<p>並列二分探索も平方分割も慣れない実装で辛かったです。ライブラリ化するかいい感じの実装方針を見つけないと実践で使える気がしません。</p>
<p>rectangle sumは実用性と汎用性のバランスが難しいなと悩む日々です。とりあえず定数倍とか無視して動くものを作ってみようかなと思っているんですが、なんだかんだ作るの面倒くさいですね。一方、簡潔でもコンパクトでもないビットベクトルなら実装できそうな気がするので、カスのwavelet matrix作ろうかなと検討中です。みなさんはどうしていますか？</p>
<p>MMA ContestとMaximum Cupの参加記録を書かなきゃいけないんですが、なかなか重い腰が上がりません。助けてほしい。</p>
<p>それでは。</p>






<hr class="block-separater">




<div class="content-footer-item">
	Tags for this post:
	
	<a class="post-tag" href="/tags/%E7%AB%B6%E6%8A%80%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0/">競技プログラミング</a>
	
	<a class="post-tag" href="/tags/%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0/">アルゴリズム</a>
	
</div>







<div class="content-footer-item neighbor">
	
	<div class="prev-post">Prev: <a href="/post/cpp-copy-constructor/">暗黙のコピーコンストラクタにご注意を</a></div>
	
	
	<div class="next-post">Next: <a href="/post/abc288d/">ABC288D - Range Add Query</a></div>
	
</div>













    
    
    
    <div class="related-tag-category-list">
        <h4 style="font-size: 1.3em;">Other posts tagged by "競技プログラミング"</h4>
        <ul class="post-list">
          
          <li class="post-item">
  <div class="post-date sub">2025-07-12</div>
  <div class="post-title"><a href="/post/range-kth-smallest-part2/">Range Kth Smallestに対するもう2つの解法</a></div>
  
</li>
          
          <li class="post-item">
  <div class="post-date sub">2025-07-05</div>
  <div class="post-title"><a href="/post/icpc2025/">ICPC国内予選2025（Chofu Mai）</a></div>
  
</li>
          
          <li class="post-item">
  <div class="post-date sub">2025-06-03</div>
  <div class="post-title"><a href="/post/abc408/">ABC408参加記録</a></div>
  
</li>
          
        </ul>
        <div class="more-area">
          
          <a class="more" href='/tags/%e7%ab%b6%e6%8a%80%e3%83%97%e3%83%ad%e3%82%b0%e3%83%a9%e3%83%9f%e3%83%b3%e3%82%b0/'>more ...</a>
          
      </div>
        </div>
    

    
    
    
    <div class="related-tag-category-list">
        <h4 style="font-size: 1.3em;">Other posts tagged by "アルゴリズム"</h4>
        <ul class="post-list">
          
          <li class="post-item">
  <div class="post-date sub">2025-07-12</div>
  <div class="post-title"><a href="/post/range-kth-smallest-part2/">Range Kth Smallestに対するもう2つの解法</a></div>
  
</li>
          
          <li class="post-item">
  <div class="post-date sub">2025-04-24</div>
  <div class="post-title"><a href="/post/binarysearch-on-segmenttree/">min_leftとmax_rightの仕組みと実装を理解する</a></div>
  
</li>
          
          <li class="post-item">
  <div class="post-date sub">2025-03-16</div>
  <div class="post-title"><a href="/post/easy-to-use-binarysearch/">めぐる式二分探索亜種を使ってみませんか？</a></div>
  
</li>
          
        </ul>
        <div class="more-area">
          
          <a class="more" href='/tags/%e3%82%a2%e3%83%ab%e3%82%b4%e3%83%aa%e3%82%ba%e3%83%a0/'>more ...</a>
          
      </div>
        </div>
    




<script src="/js/single.js"></script>





	</div><div id="content-footer" class="sub">
  
  <div class="credit">
    Power by <a href="https://gohugo.io">Hugo</a> /
    Theme <a href="https://github.com/michimani/simplog/">simplog</a> by <a href="https://github.com/michimani/">michimani</a>
  </div>
</div></body>

</html>